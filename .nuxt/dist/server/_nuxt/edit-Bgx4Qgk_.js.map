{"version":3,"file":"edit-Bgx4Qgk_.js","sources":["../../../../pages/collections/[id]/edit.vue"],"sourcesContent":["<template>\r\n  <div class=\"max-w-3xl mx-auto p-4\">\r\n    <div class=\"flex items-center gap-4 mb-6\">\r\n      <UButton icon=\"i-heroicons-arrow-left\" variant=\"ghost\" :to=\"`/collections/${collectionId}`\" />\r\n      <h1 class=\"text-2xl font-bold\">Editar Coleção</h1>\r\n    </div>\r\n\r\n    <form @submit.prevent=\"saveCollection\">\r\n      <UCard class=\"mb-6\">\r\n        <template #header>\r\n          <h2 class=\"font-semibold\">Detalhes Básicos</h2>\r\n        </template>\r\n        <div class=\"space-y-4\">\r\n          <UFormGroup label=\"Nome da Coleção\" required>\r\n            <UInput v-model=\"form.name\" placeholder=\"ex. Discos de Vinil\" required />\r\n          </UFormGroup>\r\n          <UFormGroup label=\"Descrição\">\r\n            <UTextarea v-model=\"form.description\" />\r\n          </UFormGroup>\r\n        </div>\r\n      </UCard>\r\n\r\n      <CollectionAccessControl v-model=\"form.visibility\" :collection-id=\"collectionId\" class=\"mb-6\" />\r\n\r\n      <div class=\"mb-6\">\r\n        <div class=\"flex flex-wrap gap-2 justify-between items-center mb-4 sticky top-0 z-10 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md py-4 border-b border-gray-200 dark:border-gray-800\">\r\n          <div class=\"flex items-center gap-2\">\r\n            <h2 class=\"text-lg font-semibold\">Campos Personalizados</h2>\r\n            <div v-if=\"hasSelectedFields\" class=\"flex gap-2 ml-4\">\r\n              <UButton size=\"xs\" color=\"red\" variant=\"soft\" @click=\"deleteSelectedFields\">Excluir Selecionados ({{ selectedFieldsCount }})</UButton>\r\n              <UButton size=\"xs\" color=\"gray\" variant=\"ghost\" @click=\"deselectAllFields\">Cancelar</UButton>\r\n            </div>\r\n            <UButton v-else size=\"xs\" color=\"gray\" variant=\"ghost\" @click=\"selectAllFields\">Selecionar Todos</UButton>\r\n          </div>\r\n          <UButton size=\"sm\" icon=\"i-heroicons-plus\" @click=\"addField\">Adicionar Campo</UButton>\r\n        </div>\r\n\r\n        <div class=\"space-y-4\">\r\n          <FieldDefinition\r\n            v-for=\"(field, index) in form.fields\"\r\n            :key=\"field.tempId || field.id || index\"\r\n            v-model=\"form.fields[index]\"\r\n            @remove=\"removeField(index)\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"flex justify-end gap-3 z-20 relative\">\r\n        <UButton :to=\"`/collections/${collectionId}`\" color=\"gray\" variant=\"ghost\">Cancelar</UButton>\r\n        <UButton type=\"submit\" :loading=\"loading\">Salvar Alterações</UButton>\r\n      </div>\r\n    </form>\r\n  </div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nconst route = useRoute()\r\nconst collectionId = route.params.id as string\r\nconst supabase = useSupabaseClient()\r\nconst toast = useToast()\r\nconst loading = ref(false)\r\n\r\nconst form = reactive({\r\n  name: '',\r\n  description: '',\r\n  visibility: 'private' as 'private' | 'shared' | 'public',\r\n  fields: [] as any[]\r\n})\r\n\r\n// Load Data\r\nonMounted(async () => {\r\n  const { data, error } = await supabase\r\n    .from('collections')\r\n    .select(`*, fields (*)`)\r\n    .eq('id', collectionId)\r\n    .single()\r\n  \r\n  if (error) {\r\n    toast.add({ title: 'Error', description: 'Could not load collection', color: 'red' })\r\n    navigateTo('/dashboard')\r\n    return\r\n  }\r\n\r\n  form.name = data.name\r\n  form.description = data.description\r\n  form.visibility = data.visibility || 'private'\r\n  form.fields = (data.fields || []).sort((a: any, b: any) => a.folder_order - b.folder_order).map((f: any) => ({ ...f, selected: false }))\r\n})\r\n\r\nconst addField = () => {\r\n  form.fields.push({\r\n    tempId: Date.now(), // Unique ID for v-for key\r\n    name: '',\r\n    type: 'text',\r\n    options: [],\r\n    visible: true,\r\n    required: false,\r\n    selected: false,\r\n    folder_order: form.fields.length\r\n  })\r\n}\r\n\r\nconst removeField = async (index: number) => {\r\n  const field = form.fields[index]\r\n  if (field.id) {\r\n    if (!confirm(`Tem certeza que deseja excluir o campo \"${field.name}\"? Todos os dados deste campo serão perdidos!`)) return\r\n    \r\n    // Perform delete immediately or mark for deletion?\r\n    // Safer to delete on save, but that complicates state.\r\n    // Let's delete immediately if user confirms, to simplify state sync\r\n    const { error } = await supabase.from('fields').delete().eq('id', field.id)\r\n    if (error) {\r\n        toast.add({ title: 'Erro', description: error.message, color: 'red' })\r\n        return\r\n    }\r\n  }\r\n  form.fields.splice(index, 1)\r\n}\r\n\r\n// Bulk Actions Logic\r\n\r\nconst hasSelectedFields = computed(() => form.fields.some(f => f.selected))\r\nconst selectedFieldsCount = computed(() => form.fields.filter(f => f.selected).length)\r\n\r\nconst selectAllFields = () => {\r\n  form.fields.forEach(f => f.selected = true)\r\n}\r\n\r\nconst deselectAllFields = () => {\r\n  form.fields.forEach(f => f.selected = false)\r\n}\r\n\r\nconst deleteSelectedFields = async () => {\r\n  const selected = form.fields.filter(f => f.selected)\r\n  if (selected.length === 0) return\r\n  \r\n  if (!confirm(`Excluir ${selected.length} campos? Isso executará a ação imediatamente e não poderá ser desfeito.`)) return\r\n\r\n  const idsToDelete = selected.map(f => f.id).filter(id => !!id)\r\n  \r\n  if (idsToDelete.length > 0) {\r\n     const { error } = await supabase.from('fields').delete().in('id', idsToDelete)\r\n     if (error) {\r\n       toast.add({ title: 'Erro', description: error.message, color: 'red' })\r\n       return\r\n     }\r\n  }\r\n  \r\n  // Remove from UI\r\n  form.fields = form.fields.filter(f => !f.selected)\r\n  toast.add({ title: 'Excluído', description: 'Campos removidos', color: 'green' })\r\n}\r\n\r\nconst saveCollection = async () => {\r\n// ... existing save implementation ...\r\n  try {\r\n    loading.value = true\r\n    \r\n    // 1. Update Collection\r\n    const { error: colError } = await supabase\r\n      .from('collections')\r\n      .update({ \r\n        name: form.name, \r\n        description: form.description,\r\n        visibility: form.visibility \r\n      })\r\n      .eq('id', collectionId)\r\n    \r\n    if (colError) throw colError\r\n\r\n    // 2. Process Fields\r\n    // We need to split updates and inserts to avoid sending \"id: null\" which violates constraints\r\n    \r\n    // First, map all fields to the correct payload shape including correct folder_order\r\n    const allFieldsPayload = form.fields.map((f, index) => ({\r\n      ...f,\r\n      collection_id: collectionId,\r\n      folder_order: index,\r\n      // Ensure we only send what's needed\r\n      name: f.name,\r\n      type: f.type,\r\n      options: f.options,\r\n      visible: f.visible,\r\n      required: f.required || false\r\n    }))\r\n\r\n    const fieldsToUpdate = allFieldsPayload.filter((f: any) => f.id).map((f: any) => ({\r\n      id: f.id,\r\n      collection_id: f.collection_id,\r\n      name: f.name,\r\n      type: f.type,\r\n      options: f.options,\r\n      visible: f.visible,\r\n      required: f.required,\r\n      folder_order: f.folder_order\r\n    }))\r\n\r\n    const fieldsToInsert = allFieldsPayload.filter((f: any) => !f.id).map((f: any) => ({\r\n      collection_id: f.collection_id,\r\n      name: f.name,\r\n      type: f.type,\r\n      options: f.options,\r\n      visible: f.visible,\r\n      required: f.required,\r\n      folder_order: f.folder_order\r\n    }))\r\n\r\n    // Execute Update (Upsert) checking for errors\r\n    if (fieldsToUpdate.length > 0) {\r\n      const { error: updateError } = await supabase\r\n        .from('fields')\r\n        .upsert(fieldsToUpdate)\r\n      if (updateError) throw updateError\r\n    }\r\n\r\n    // Execute Insert checking for errors\r\n    if (fieldsToInsert.length > 0) {\r\n      const { error: insertError } = await supabase\r\n        .from('fields')\r\n        .insert(fieldsToInsert)\r\n      if (insertError) throw insertError\r\n    }\r\n\r\n    toast.add({ title: 'Sucesso', description: 'Coleção atualizada', color: 'green' })\r\n    navigateTo(`/collections/${collectionId}`)\r\n\r\n  } catch (error: any) {\r\n    toast.add({ title: 'Erro', description: error.message, color: 'red' })\r\n  } finally {\r\n    loading.value = false\r\n  }\r\n}\r\n</script>\r\n"],"names":["_ssrRenderAttrs","_mergeProps","_unref","_ssrRenderComponent","_push","_parent","_createVNode","_","_scopeId","_toDisplayString","_ssrRenderList"],"mappings":"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"}