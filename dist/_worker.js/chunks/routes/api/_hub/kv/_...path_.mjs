import{l as t,M as e,N as a,b as s,O as o,P as r,Q as i,R as n,S as m,m as d,v as u}from"../../../../_/nitro.mjs";import{r as c}from"../../../../_/auth.mjs";import"node:async_hooks";const h={GET:"read",HEAD:"read",PUT:"write",DELETE:"write"};function setMetaHeaders(t,e){e.mtime&&m(t,"last-modified",new Date(e.mtime).toUTCString()),e.ttl&&(m(t,"x-ttl",`${e.ttl}`),m(t,"cache-control",`max-age=${e.ttl}`))}const l=t(async m=>{await c(m),d("kv");return function(m,d={}){return t(async t=>{const u=d.resolvePath?.(t)??t.path,c=u[u.length-1],l=":"===c||"/"===c,w=l?e(u):a(u);if(!(t.method in h))throw s({statusCode:405,statusMessage:`Method Not Allowed: ${t.method}`});try{await(d.authorize?.({type:h[t.method],event:t,key:w}))}catch(t){throw o(t)?t:s({statusMessage:t?.message,statusCode:401,...t})}if("GET"===t.method){if(l)return(await m.getKeys(w)).map(t=>t.replace(/:/g,"/"));const e="application/octet-stream"===r(t,"accept"),a=await(e?m.getItemRaw(w):m.getItem(w));if(null===a)throw s({statusCode:404,statusMessage:"KV value not found"});return setMetaHeaders(t,await m.getMeta(w)),e?a:i(a)}if("HEAD"===t.method){if(!await m.hasItem(w))throw s({statusCode:404,statusMessage:"KV value not found"});return setMetaHeaders(t,await m.getMeta(w)),""}if("PUT"===t.method){const e="application/octet-stream"===r(t,"content-type"),a={ttl:Number(r(t,"x-ttl"))||void 0};if(e){const e=await n(t,!1);await m.setItemRaw(w,e,a)}else{const e=await n(t,"utf8");void 0!==e&&await m.setItem(w,e,a)}return"OK"}if("DELETE"===t.method)return await(l?m.clear(w):m.removeItem(w)),"OK";throw s({statusCode:405,statusMessage:`Method Not Allowed: ${t.method}`})})}(u(),{resolvePath:t=>t.context.params.path||""})(m)});export{l as default};
//# sourceMappingURL=_...path_.mjs.map
